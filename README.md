# SeedV Demo API

## 概述
本项目是基于 FastAPI，Tortoise ORM 和 Celery 构建。

## 特性
- 创建具有特定命令和提示词的任务申请（“Apply”）。
- 根据提供的命令类型自动生成一系列流程（“Process”）。
- 跟踪每个流程的状态和结果。
- 检索每个申请及其关联流程的详细信息。

## 表结构
### Apply 表
- `id`: 主键（整数）
- `command`: 命令类型（字符串，最大长度 32 eg: command1, command2）
- `prompt`: 提示词（文本）
- `status`: 整体状态（字符串，最大长度 32，默认为 "pending", "finish"）
- `final_result`: 最终结果（JSON格式，可为 null, 若为音频或视频存储其地址）
- `created_at`: 创建时间（日期时间）
- `updated_at`: 更新时间（日期时间）

### Process 表
- `id`: 主键（整数）
- `apply_id`: 所属 Apply 记录的外键（整数）
- `child_id`: 下一个 Process 的外键（自引用，可为 null）
- `type`: 处理类型（字符串，最大长度 32 ） 举例： "text_search", "text_to_speech", "text_to_image", "image_to_video"
- `status`: 状态（字符串，最大长度 32，默认为 "pending", "running", "finish"）
- `sequence`: 执行顺序（整数）
- `result`: 步骤的输出结果（JSON格式，可为 null）
- `input`: 该步骤的输入（JSON格式，可为 null）
- `created_at`: 创建时间（日期时间）
- `updated_at`: 更新时间（日期时间）

## API 接口

### 创建申请
- **POST** `/api/apply`
- 根据提供的命令和提示词Prompt创建新的申请记录，并生成一系列待执行流程。

### 获取申请详情
- **GET** `/api/apply/{apply_id}`
- 获取特定申请的详细信息，包括执行状态和最终返回结果。

## 安装和设置
- Python 3.11
- FastAPI
- Tortoise ORM
- Celery（用于异步任务处理）

## 待优化点及完善功能
### 1. 命令command配置信息的动态管理

- **数据库设计**：创建 `commands` 表用于存储命令配置信息，包括命令名称和对应的流程序列。
- **缓存逻辑**：在查询命令配置信息前，先检查 Redis 缓存中是否存在。如果不存在，从数据库查询并将结果缓存。
- **更新和失效策略**：实现自动更新 Redis 缓存或使缓存失效的机制，以应对命令配置信息的更新。

### 2. 用户登录与 Token 校验

- **用户认证**：采用 JWT (JSON Web Tokens) 实现用户认证系统。在用户登录验证成功后，生成并返回 JWT token。
- **Token 存储**：将 JWT token 存储在 Redis 中，并设置 8 小时的过期时间，以有效管理 token 生命周期。
- **请求校验**：API 接口中将加入中间件或钩子，用于校验请求头中的 token，确保只有验证通过的请求才能访问受保护资源。

### 3. 异步任务调用

- **任务队列设计**：使用 Celery 异步任务队列，此处根据调外部服务的不通策略也有差别。文本接口一般直接返回，文本转语音、文本转视频等任务,需要先发起再等待x秒查询结果，直到查询到结果数据。
- **状态查询和更新**：设计状态查询机制，用于轮询或通知任务完成状态。在任务完成后，更新数据库状态，并可选地通知前端（基于websocket）。
- **服务调用优化**：针对长时间等待，设计超时和重试策略，确保服务的高可用性。

### 4. 复杂的场景
- 根据文本信息返回多张图片的详细描述信息，分别调文生图大模型生成多张图片，然后合并成一个视频。